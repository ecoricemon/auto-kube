---
# For synchronize
# Generate ssh key
- hosts: "{{ key_send }}"
  gather_facts: no
  tasks:
  - name: Check id_rsa and id_rsa.pub
    ansible.builtin.find:
      path: ~/.ssh
      patterns: 'id_rsa,id_rsa.pub'
    register: sshfiles

  - name: Create ssh key
    ansible.builtin.shell: ssh-keygen -t rsa -f ~/.ssh/id_rsa -N ''
    when: sshfiles.matched != 2

  - name: Copy ssh key to control machine
    ansible.builtin.fetch:
      src: ~/.ssh/id_rsa.pub
      dest: ./
      flat: yes

# Copy ssh key
- hosts: "{{ key_recv }}"
  gather_facts: no
  tasks:
  - name: Copy ssh key to nodes
    ansible.builtin.copy:
      src: ./id_rsa.pub
      dest: ~/.ssh/id_rsa.pub.tmp

  - name: Check ssh key
    ansible.builtin.shell: cat ~/.ssh/authorized_keys | grep "$(cat ~/.ssh/id_rsa.pub.tmp)"
    register: grep_key
    failed_when: grep_key.rc == 2

  - name: Append ssh key to authorized_keys
    ansible.builtin.shell: cat ~/.ssh/id_rsa.pub.tmp >> ~/.ssh/authorized_keys
    when: grep_key.rc == 1

  - ansible.builtin.file:
      path: ~/.ssh/id_rsa.pub.tmp
      state: absent

# Remove ssh key from control machine
- hosts: localhost
  gather_facts: no
  tasks:
  - name: Remove ssh key from control machine
    ansible.builtin.file:
      path: ./id_rsa.pub
      state: absent

# Create known hosts file
- hosts: "{{ key_send }}"
  gather_facts: no
  tasks:
  - name: Make sure ~/.ssh/known_hosts exists
    ansible.builtin.stat:
      path: ~/.ssh/known_hosts
    register: known

  - ansible.builtin.file:
      path: ~/.ssh/known_hosts
      state: touch
    when: not known['stat']['exists']

  - name: Check key in the known_hosts
    ansible.builtin.shell: ssh-keygen -F "{{ hostvars[item]['ansible_host'] }}" 2>/dev/null
    loop: "{{ query('inventory_hostnames', key_recv) }}"
    register: keys
    failed_when: keys.rc == 255

  - ansible.builtin.shell: ssh-keyscan -H -t ecdsa "{{ hostvars[item['item']]['ansible_host'] }}" >> ~/.ssh/known_hosts
    when: item.rc == 1
    loop: "{{ keys.results }}"

